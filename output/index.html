<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Advanced Python</title><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><meta name="author" content="Carl Meyer"></meta><meta name="description" content="a presentation for ConFoo 2014"></meta><meta name="keywords" content="presentation, advanced, python, confoo"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="css/oddbird.css" media="all"></link></head><body class="impress-not-supported"><div id="impress" data-transition-duration="400"><div class="step" step="0" id="title" data-x="0" data-y="0"><h1 id="advanced-python">Advanced Python</h1><p><div class="vcard">
<a href="http://www.oddbird.net">
  <img src="images/logo.svg" alt="OddBird" class="logo" />
</a>
<h2 class="fn">Carl Meyer</h2>
<ul class="links">
  <li><a href="http://www.oddbird.net" class="org url">oddbird.net</a></li>
  <li><a href="https://twitter.com/carljm" rel="me">@carljm</a></li>
</ul>
</div></p></div><div class="step" step="1" id="thistalk" data-reveal="1" data-x="1600" data-y="0"><h1 id="this-talk">This talk</h1><ul><li>Decorators</li><li>Context managers</li><li>Descriptors</li><li>Iterators</li><li>Generators</li><li>Metaclasses</li></ul></div><div class="step" step="2" data-reveal="1" data-x="3200" data-y="0"><h1 id="how">How</h1><ul><li>Introduce a feature</li><li>Toy example</li><li>Real example(s)</li><li>Just a taste!</li><li>Cautions?</li><li>Link to docs</li><li>Python 3</li></ul><div class="notes"><p>No stress; doc links will be live in online slides.</p><p>All code is Py3, but will note Py2 differences.</p></div></div><div class="step" step="3" data-reveal="1" data-x="4800" data-y="0"><h1 id="me">Me</h1><ul><li>Writing Python since 2002.</li><li>Professionally since 2007.</li><li>Mostly web development.</li><li>OSS: pip, virtualenv, Django</li></ul></div><div class="step" step="4" data-x="6400" data-y="0"><h1 id="decorators">Decorators</h1><p>Functions are first class:</p><pre class="highlight code pycon"><span class="k"></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">say_hi</span><span class="p">():</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="s">"Hi!"</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">
</span><span class="k"></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">call_twice</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">func</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">func</span><span class="p">()</span>
<span class="gp">...</span>
<span class="go">
</span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">call_twice</span><span class="p">(</span><span class="n">say_hi</span><span class="p">)</span>
<span class="go">Hi!
Hi!</span></pre><div class="notes"><p>We can pass a function around like any other object.</p><p>Create a function that prints "Hi!"</p><p>Pass it as an argument to another function (note lack of parens; with parens
we'd be calling the function and passing in its return value, which is
None).</p><p>Then call it by another name, twice (now we have parens!)</p></div></div><div class="step" step="5" data-reveal="1" data-x="8000" data-y="0"><h1 id="decorator">Decorator</h1><p>A function that takes a function as an argument, and returns a function.</p><pre class="highlight code pycon"><span class="k"></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">noisy</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="gp">... </span>   <span class="k">def</span> <span class="nf">decorated</span><span class="p">():</span>
<span class="gp">... </span>       <span class="k">print</span><span class="p">(</span><span class="s">"Before"</span><span class="p">)</span>
<span class="gp">... </span>       <span class="n">func</span><span class="p">()</span>
<span class="gp">... </span>       <span class="k">print</span><span class="p">(</span><span class="s">"After"</span><span class="p">)</span>
<span class="gp">... </span>   <span class="k">return</span> <span class="n">decorated</span>
<span class="go">
</span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">say_hi_noisy</span> <span class="o">=</span> <span class="n">noisy</span><span class="p">(</span><span class="n">say_hi</span><span class="p">)</span>
<span class="go">
</span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">say_hi_noisy</span><span class="p">()</span>
<span class="go">Before
Hi!
After</span></pre><div class="notes"><p>We pass in say_hi to noisy, and get back the function "decorated"; when we
call it, we get the Before, then the function we passed in (say_hi) is
called, then we get After.</p><p>The function "decorated" is a closure; it "closes over" the value of the
variable "func" in its containing scope.</p></div></div><div class="step" step="6" data-emphasize-lines="4,5" data-x="9600" data-y="0"><h1 id="decorator-syntax">Decorator syntax</h1><p>In place of:</p><pre class="highlight code python"><span class="ln">1 </span><span class="k">def</span> <span class="nf">say_hi</span><span class="p">():</span>
<span class="ln">2 </span>    <span class="k">print</span><span class="p">(</span><span class="s">"Hi!"</span><span class="p">)</span>
<span class="ln">3 </span>
<span class="ln">4 </span><span class="n">say_hi</span> <span class="o">=</span> <span class="n">noisy</span><span class="p">(</span><span class="n">say_hi</span><span class="p">)</span></pre><p>we can write:</p><pre class="highlight code python"><span class="ln">1 </span><span class="nd">@noisy</span>
<span class="ln">2 </span><span class="k">def</span> <span class="nf">say_hi</span><span class="p">():</span>
<span class="ln">3 </span>    <span class="k">print</span><span class="p">(</span><span class="s">"Hi!"</span><span class="p">)</span></pre><div class="notes"><p>If we don't need the original (undecorated) function.</p></div></div><div class="step" step="7" data-x="11200" data-y="0"><h1 id="either-way">Either way:</h1><pre class="highlight code pycon"><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">say_hi</span><span class="p">()</span>
<span class="go">Before
Hi!
After</span></pre></div><div class="step" step="8" data-x="12800" data-y="0"><h1 id="but">But:</h1><pre class="highlight code pycon"><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">say_hi</span>
<span class="go">&lt;function noisy.&lt;locals&gt;.decorated at 0x...&gt;

</span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">help</span><span class="p">(</span><span class="n">say_hi</span><span class="p">)</span>
<span class="go">Help on function decorated:
decorated()</span></pre></div><div class="step" step="9" data-emphasize-lines="1,4" data-x="14400" data-y="0"><h1 id="fixing-repr-and-help">Fixing <tt>repr()</tt> and <tt>help()</tt></h1><pre class="highlight code python"><span class="ln"> 1 </span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="ln"> 2 </span>
<span class="ln"> 3 </span><span class="k">def</span> <span class="nf">noisy</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="ln"> 4 </span>    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="ln"> 5 </span>    <span class="k">def</span> <span class="nf">decorated</span><span class="p">():</span>
<span class="ln"> 6 </span>        <span class="k">print</span><span class="p">(</span><span class="s">"Before"</span><span class="p">)</span>
<span class="ln"> 7 </span>        <span class="n">func</span><span class="p">()</span>
<span class="ln"> 8 </span>        <span class="k">print</span><span class="p">(</span><span class="s">"After"</span><span class="p">)</span>
<span class="ln"> 9 </span>    <span class="k">return</span> <span class="n">decorated</span></pre><div class="notes"><p>Python standard library has a decorator that helps us make decorators!</p><p>Copies the function name and docstring of the decorated function onto the
decorator, so it isn't obscured.</p></div></div><div class="step" step="10" data-x="16000" data-y="0"><h1 id="fixed">Fixed!</h1><pre class="highlight code pycon"><span class="nd"></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@noisy</span>
<span class="gp">... </span><span class="k">def</span> <span class="nf">say_hi</span><span class="p">():</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="s">"Hi!"</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">
</span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">say_hi</span>
<span class="go">&lt;function say_hi at 0x...&gt;

</span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">help</span><span class="p">(</span><span class="n">say_hi</span><span class="p">)</span>
<span class="go">Help on function say_hi:
say_hi()</span></pre></div><div class="step" step="11" data-x="17600" data-y="0"><h1 id="let-s-try-another">Let's try another:</h1><pre class="highlight code pycon"><span class="nd"></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@noisy</span>
<span class="gp">... </span><span class="k">def</span> <span class="nf">square</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span>
<span class="gp">...</span>
<span class="go">
</span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">square</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):
</span>  File <span class="nb">"&lt;stdin&gt;"</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
<span class="gr">TypeError</span>: <span class="n">decorated() takes 0 positional arguments but</span>
<span class="go">           1 was given</span></pre><h1 id="oops">Oops!</h1></div><div class="step" step="12" data-emphasize-lines="3,5" data-x="19200" data-y="0"><h1 id="use-args-and-kwargs">Use <tt>*args</tt> and <tt>**kwargs</tt></h1><p>to write decorators that can wrap any function signature:</p><pre class="highlight code python"><span class="ln">1 </span><span class="k">def</span> <span class="nf">noisy</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="ln">2 </span>    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="ln">3 </span>    <span class="k">def</span> <span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="ln">4 </span>        <span class="k">print</span><span class="p">(</span><span class="s">"Before"</span><span class="p">)</span>
<span class="ln">5 </span>        <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="ln">6 </span>        <span class="k">print</span><span class="p">(</span><span class="s">"After"</span><span class="p">)</span>
<span class="ln">7 </span>    <span class="k">return</span> <span class="n">decorated</span></pre><div class="notes"><p>Depends on the type of decorators. Some decorators might look at or even
change the arguments, so this total flexibility wouldn't work.</p></div></div><div class="step" step="13" data-x="20800" data-y="0"><h1 id="a-real-example">A real example</h1><pre class="highlight code python"><span class="k">def</span> <span class="nf">login_required</span><span class="p">(</span><span class="n">view_func</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">view_func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decorated</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/login/'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">view_func</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">decorated</span>

<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">edit_profile</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">pass</span> <span class="c"># ...</span></pre><div class="notes"><p>Simplified from the actual implementation.</p><p>Here we are hardcoding the login URL to redirect to.</p></div></div><div class="step" step="14" data-emphasize-lines="2,9" data-x="22400" data-y="0"><h1 id="configurable-decorators">Configurable decorators</h1><pre class="highlight code python"><span class="ln"> 1 </span><span class="k">def</span> <span class="nf">login_required</span><span class="p">(</span><span class="n">login_url</span><span class="p">):</span>
<span class="ln"> 2 </span>    <span class="k">def</span> <span class="nf">actual_decorator</span><span class="p">(</span><span class="n">view_func</span><span class="p">):</span>
<span class="ln"> 3 </span>        <span class="nd">@wraps</span><span class="p">(</span><span class="n">view_func</span><span class="p">)</span>
<span class="ln"> 4 </span>        <span class="k">def</span> <span class="nf">decorated</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="ln"> 5 </span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
<span class="ln"> 6 </span>                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">login_url</span><span class="p">)</span>
<span class="ln"> 7 </span>            <span class="k">return</span> <span class="n">view_func</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="ln"> 8 </span>        <span class="k">return</span> <span class="n">decorated</span>
<span class="ln"> 9 </span>    <span class="k">return</span> <span class="n">actual_decorator</span>
<span class="ln">10 </span>
<span class="ln">11 </span><span class="nd">@login_required</span><span class="p">(</span><span class="s">'/login/'</span><span class="p">)</span>
<span class="ln">12 </span><span class="k">def</span> <span class="nf">edit_profile</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="ln">13 </span>    <span class="k">pass</span> <span class="c"># ...</span></pre><div class="notes"><p>A decorator that takes arguments is really a decorator factory: a function
that returns a decorator.</p><p>And a decorator, of course, is a function that returns a function: so we end
up with double-nested closures.</p></div></div><div class="step" step="15" data-emphasize-lines="9,10" data-x="24000" data-y="0"><h1 id="optionally-configurable">Optionally configurable</h1><pre class="highlight code python"><span class="ln"> 1 </span><span class="k">def</span> <span class="nf">login_required</span><span class="p">(</span><span class="n">view_func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">login_url</span><span class="o">=</span><span class="s">'/login/'</span><span class="p">):</span>
<span class="ln"> 2 </span>    <span class="k">def</span> <span class="nf">actual_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="ln"> 3 </span>        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="ln"> 4 </span>        <span class="k">def</span> <span class="nf">decorated</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="ln"> 5 </span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
<span class="ln"> 6 </span>                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">login_url</span><span class="p">)</span>
<span class="ln"> 7 </span>            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="ln"> 8 </span>        <span class="k">return</span> <span class="n">decorated</span>
<span class="ln"> 9 </span>    <span class="k">if</span> <span class="n">view_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
<span class="ln">10 </span>        <span class="k">return</span> <span class="n">actual_decorator</span><span class="p">(</span><span class="n">view_func</span><span class="p">)</span>
<span class="ln">11 </span>    <span class="k">return</span> <span class="n">actual_decorator</span>
<span class="ln">12 </span>
<span class="ln">13 </span><span class="nd">@login_required</span>
<span class="ln">14 </span><span class="k">def</span> <span class="nf">view_profile</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="ln">15 </span>    <span class="k">pass</span> <span class="c"># ...</span>
<span class="ln">16 </span>
<span class="ln">17 </span><span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">'/other_login/'</span><span class="p">)</span>
<span class="ln">18 </span><span class="k">def</span> <span class="nf">edit_profile</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="ln">19 </span>    <span class="k">pass</span> <span class="c"># ...</span></pre><div class="notes"><p>Combining the last two forms of decorators, returning either a decorator, or
an already-decorated view function, depending what arguments we get.</p><p>Could avoid the implementation complexity if we didn't mind a pair of empty
parens in the first usage, but requiring those makes it easier to use the
decorator wrong.</p><p>This requires passing in login_url as a keyword argument, we could be even
cleverer if we want by type-checking the first argument (is it a function?
is it a string?)</p></div></div><div class="step" step="16" data-x="25600" data-y="0"><h1 id="with-lazy-return-values">With lazy return values:</h1><pre class="highlight code python"><span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decorated</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">sort_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'sort'</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sort_by</span><span class="p">:</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">'context'</span><span class="p">]</span>
            <span class="n">ctx</span><span class="p">[</span><span class="s">'queryset'</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">[</span><span class="s">'queryset'</span><span class="p">]</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                <span class="n">sort_by</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
    <span class="k">return</span> <span class="n">decorated</span>

 <span class="nd">@sort</span>
 <span class="k">def</span> <span class="nf">list_widgets</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
     <span class="k">return</span> <span class="n">TemplateResponse</span><span class="p">(</span>
         <span class="n">request</span><span class="p">,</span>
         <span class="s">'widget_list.html'</span><span class="p">,</span>
         <span class="p">{</span><span class="s">'queryset'</span><span class="p">:</span> <span class="n">Widget</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()},</span>
         <span class="p">)</span></pre><div class="notes"><p>The list_widgets view returns a TemplateResponse, which renders an HTML
template but does so lazily, meaning our decorator can still poke at the
context (values passed to template) before the template is rendered. In this
case we sort the queryset based on a field name given in the request.</p><p>This decorator could be applied to provide generic sortability to any view
that renders a queryset in its template.</p><p>(Note: needs error handling.)</p></div></div></div><div id="hovercraft-help" class="hide"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Left, Down, Page Down</th><td>Next slide</td></tr><tr><th>Right, Up, Page Up</th><td>Previous slide</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/jquery-2.1.0.min.js"></script><script type="text/javascript" src="js/oddbird.js"></script><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script></body></html>