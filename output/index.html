<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Advanced Python</title><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><meta name="author" content="Carl Meyer"></meta><meta name="description" content="a presentation for ConFoo 2014"></meta><meta name="keywords" content="presentation, advanced, python, confoo"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="css/oddbird.css" media="all"></link></head><body class="impress-not-supported"><div id="impress" data-transition-duration="400"><div class="step" step="0" id="title" data-x="0" data-y="0"><h1 id="advanced-python">Advanced Python</h1><p><div class="vcard">
<a href="http://www.oddbird.net">
  <img src="images/logo.svg" alt="OddBird" class="logo" />
</a>
<h2 class="fn">Carl Meyer</h2>
<ul class="links">
  <li><a href="http://www.oddbird.net" class="org url">oddbird.net</a></li>
  <li><a href="https://twitter.com/carljm" rel="me">@carljm</a></li>
</ul>
</div></p></div><div class="step" step="1" id="thistalk" data-reveal="1" data-x="1600" data-y="0"><h1 id="this-talk">This talk</h1><ul><li>Decorators</li><li>Context managers</li><li>Descriptors</li><li>Iterators</li><li>Generators</li><li>Metaclasses</li></ul></div><div class="step" step="2" data-reveal="1" data-x="3200" data-y="0"><h1 id="how">How</h1><ul><li>Introduce a feature</li><li>Example(s)</li><li>Just a taste!</li><li>Cautions?</li><li>Link to docs</li><li>Python 3</li></ul><div class="notes"><p>Docs links on final slide. No stress; doc links will be live in online
slides.</p><p>All code is Py3, but will note Py2 differences.</p></div></div><div class="step" step="3" data-reveal="1" data-x="4800" data-y="0"><h1 id="me">Me</h1><ul><li>Writing Python since 2002.</li><li>Professionally since 2007.</li><li>Mostly web development.</li><li>OSS: pip, virtualenv, Django</li></ul></div><div class="step" step="4" data-x="6400" data-y="0"><h1 id="decorators">Decorators</h1><p>Functions are first class:</p><pre class="highlight code pycon"><span class="k"></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">say_hi</span><span class="p">():</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="s">"Hi!"</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">
</span><span class="k"></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">call_twice</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">func</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">func</span><span class="p">()</span>
<span class="gp">...</span>
<span class="go">
</span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">call_twice</span><span class="p">(</span><span class="n">say_hi</span><span class="p">)</span>
<span class="go">Hi!
Hi!</span></pre><div class="notes"><p>We can pass a function around like any other object.</p><p>Pass it as an argument to another function (no parens is reference, parents
means a call).</p><p>Then call it by another name, twice (now parens!)</p></div></div><div class="step" step="5" data-reveal="1" data-emphasize-lines-step="11,13" data-kill-linenos="1" data-x="8000" data-y="0"><h1 id="decorator">Decorator</h1><p>A function that takes a function as an argument, and returns a function.</p><pre class="highlight code pycon"><span class="ln"> 1 </span><span class="k"></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">noisy</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="ln"> 2 </span><span class="gp">... </span>   <span class="k">def</span> <span class="nf">decorated</span><span class="p">():</span>
<span class="ln"> 3 </span><span class="gp">... </span>       <span class="k">print</span><span class="p">(</span><span class="s">"Before"</span><span class="p">)</span>
<span class="ln"> 4 </span><span class="gp">... </span>       <span class="n">func</span><span class="p">()</span>
<span class="ln"> 5 </span><span class="gp">... </span>       <span class="k">print</span><span class="p">(</span><span class="s">"After"</span><span class="p">)</span>
<span class="ln"> 6 </span><span class="gp">... </span>   <span class="k">return</span> <span class="n">decorated</span>
<span class="ln"> 7 </span><span class="go">
</span><span class="ln"> 8 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">say_hi_noisy</span> <span class="o">=</span> <span class="n">noisy</span><span class="p">(</span><span class="n">say_hi</span><span class="p">)</span>
<span class="ln"> 9 </span><span class="go">
</span><span class="ln">10 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">say_hi_noisy</span><span class="p">()</span>
<span class="ln">11 </span><span class="go">Before
</span><span class="ln">12 </span><span class="go">Hi!
</span><span class="ln">13 </span><span class="go">After</span></pre><div class="notes"><p>We pass in say_hi to noisy, and get back the function "decorated"; when we
call it, we get the Before, then the function we passed in (say_hi) is
called, then we get After.</p><p>The function "decorated" is a closure; it "closes over" the value of the
variable "func" in its containing scope.</p></div></div><div class="step" step="6" data-emphasize-lines-step="4,5" data-kill-linenos="1" data-x="9600" data-y="0"><h1 id="decorator-syntax">Decorator syntax</h1><p>In place of:</p><pre class="highlight code python"><span class="ln">1 </span><span class="k">def</span> <span class="nf">say_hi</span><span class="p">():</span>
<span class="ln">2 </span>    <span class="k">print</span><span class="p">(</span><span class="s">"Hi!"</span><span class="p">)</span>
<span class="ln">3 </span>
<span class="ln">4 </span><span class="n">say_hi</span> <span class="o">=</span> <span class="n">noisy</span><span class="p">(</span><span class="n">say_hi</span><span class="p">)</span></pre><p>we can write:</p><pre class="highlight code python"><span class="ln">1 </span><span class="nd">@noisy</span>
<span class="ln">2 </span><span class="k">def</span> <span class="nf">say_hi</span><span class="p">():</span>
<span class="ln">3 </span>    <span class="k">print</span><span class="p">(</span><span class="s">"Hi!"</span><span class="p">)</span></pre><div class="notes"><p>If we don't need the original (undecorated) function.</p></div></div><div class="step" step="7" data-x="11200" data-y="0"><h1 id="either-way">Either way:</h1><pre class="highlight code pycon"><span class="ln">1 </span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">say_hi</span><span class="p">()</span>
<span class="ln">2 </span><span class="go">Before
</span><span class="ln">3 </span><span class="go">Hi!
</span><span class="ln">4 </span><span class="go">After</span></pre></div><div class="step" step="8" data-emphasize-lines-step="2,6" data-kill-linenos="1" data-x="12800" data-y="0"><h1 id="but">But:</h1><pre class="highlight code pycon"><span class="ln">1 </span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">say_hi</span>
<span class="ln">2 </span><span class="go">&lt;function noisy.&lt;locals&gt;.decorated at 0x...&gt;
</span><span class="ln">3 </span><span class="go">
</span><span class="ln">4 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">help</span><span class="p">(</span><span class="n">say_hi</span><span class="p">)</span>
<span class="ln">5 </span><span class="go">Help on function decorated:
</span><span class="ln">6 </span><span class="go">decorated()</span></pre><div class="notes"><p>The help and repr for our function now say nothing about <tt>say_hi</tt>, they
claim that it's the inner function returned from the decorator.</p><p>Which it is!</p><p>But we'd like to hide this and treat it as if it were the original function.</p></div></div><div class="step" step="9" data-emphasize-lines-step="1,4" data-x="14400" data-y="0"><h1 id="fixing-repr-and-help">Fixing <tt>repr()</tt> and <tt>help()</tt></h1><pre class="highlight code python"><span class="ln"> 1 </span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="ln"> 2 </span>
<span class="ln"> 3 </span><span class="k">def</span> <span class="nf">noisy</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="ln"> 4 </span>    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="ln"> 5 </span>    <span class="k">def</span> <span class="nf">decorated</span><span class="p">():</span>
<span class="ln"> 6 </span>        <span class="k">print</span><span class="p">(</span><span class="s">"Before"</span><span class="p">)</span>
<span class="ln"> 7 </span>        <span class="n">func</span><span class="p">()</span>
<span class="ln"> 8 </span>        <span class="k">print</span><span class="p">(</span><span class="s">"After"</span><span class="p">)</span>
<span class="ln"> 9 </span>    <span class="k">return</span> <span class="n">decorated</span></pre><div class="notes"><p>Python standard library has a decorator that helps us make decorators!</p><p>Copies the function name and docstring of the decorated function onto the
decorator, so it isn't obscured.</p></div></div><div class="step" step="10" data-emphasize-lines-step="7,11" data-kill-linenos="1" data-x="16000" data-y="0"><h1 id="fixed">Fixed!</h1><pre class="highlight code pycon"><span class="ln"> 1 </span><span class="nd"></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@noisy</span>
<span class="ln"> 2 </span><span class="gp">... </span><span class="k">def</span> <span class="nf">say_hi</span><span class="p">():</span>
<span class="ln"> 3 </span><span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="s">"Hi!"</span><span class="p">)</span>
<span class="ln"> 4 </span><span class="gp">...</span>
<span class="ln"> 5 </span><span class="go">
</span><span class="ln"> 6 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">say_hi</span>
<span class="ln"> 7 </span><span class="go">&lt;function say_hi at 0x...&gt;
</span><span class="ln"> 8 </span><span class="go">
</span><span class="ln"> 9 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">help</span><span class="p">(</span><span class="n">say_hi</span><span class="p">)</span>
<span class="ln">10 </span><span class="go">Help on function say_hi:
</span><span class="ln">11 </span><span class="go">say_hi()</span></pre></div><div class="step" step="11" data-x="17600" data-y="0"><h1 id="let-s-try-another">Let's try another:</h1><pre class="highlight code pycon"><span class="nd"></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@noisy</span>
<span class="gp">... </span><span class="k">def</span> <span class="nf">square</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span>
<span class="gp">...</span>
<span class="go">
</span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">square</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):
</span>  File <span class="nb">"&lt;stdin&gt;"</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
<span class="gr">TypeError</span>: <span class="n">decorated() takes 0 positional arguments but</span>
<span class="go">           1 was given</span></pre><h1 id="oops">Oops!</h1></div><div class="step" step="12" data-emphasize-lines-step="3,5" data-x="19200" data-y="0"><h1 id="use-args-and-kwargs">Use <tt>*args</tt> and <tt>**kwargs</tt></h1><p>to write decorators that can wrap any function signature:</p><pre class="highlight code python"><span class="ln">1 </span><span class="k">def</span> <span class="nf">noisy</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="ln">2 </span>    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="ln">3 </span>    <span class="k">def</span> <span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="ln">4 </span>        <span class="k">print</span><span class="p">(</span><span class="s">"Before"</span><span class="p">)</span>
<span class="ln">5 </span>        <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="ln">6 </span>        <span class="k">print</span><span class="p">(</span><span class="s">"After"</span><span class="p">)</span>
<span class="ln">7 </span>    <span class="k">return</span> <span class="n">decorated</span></pre><div class="notes"><p>Depends on the type of decorators. Some decorators might look at or even
change the arguments, so this total flexibility wouldn't work.</p></div></div><div class="step" step="13" data-emphasize-lines-step="3,4,5,6" data-x="20800" data-y="0"><h1 id="a-real-example">A real example</h1><pre class="highlight code python"><span class="ln"> 1 </span><span class="k">def</span> <span class="nf">login_required</span><span class="p">(</span><span class="n">view_func</span><span class="p">):</span>
<span class="ln"> 2 </span>    <span class="nd">@wraps</span><span class="p">(</span><span class="n">view_func</span><span class="p">)</span>
<span class="ln"> 3 </span>    <span class="k">def</span> <span class="nf">decorated</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="ln"> 4 </span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
<span class="ln"> 5 </span>            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/login/'</span><span class="p">)</span>
<span class="ln"> 6 </span>        <span class="k">return</span> <span class="n">view_func</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="ln"> 7 </span>    <span class="k">return</span> <span class="n">decorated</span>
<span class="ln"> 8 </span>
<span class="ln"> 9 </span><span class="nd">@login_required</span>
<span class="ln">10 </span><span class="k">def</span> <span class="nf">edit_profile</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="ln">11 </span>    <span class="k">pass</span> <span class="c"># ...</span></pre><div class="notes"><p>Simplified from the actual implementation.</p><p>Here we are hardcoding the login URL to redirect to.</p></div></div><div class="step" step="14" data-emphasize-lines-step="2,6,9" data-x="22400" data-y="0"><h1 id="configurable-decorators">Configurable decorators</h1><pre class="highlight code python"><span class="ln"> 1 </span><span class="k">def</span> <span class="nf">login_required</span><span class="p">(</span><span class="n">login_url</span><span class="p">):</span>
<span class="ln"> 2 </span>    <span class="k">def</span> <span class="nf">actual_decorator</span><span class="p">(</span><span class="n">view_func</span><span class="p">):</span>
<span class="ln"> 3 </span>        <span class="nd">@wraps</span><span class="p">(</span><span class="n">view_func</span><span class="p">)</span>
<span class="ln"> 4 </span>        <span class="k">def</span> <span class="nf">decorated</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="ln"> 5 </span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
<span class="ln"> 6 </span>                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">login_url</span><span class="p">)</span>
<span class="ln"> 7 </span>            <span class="k">return</span> <span class="n">view_func</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="ln"> 8 </span>        <span class="k">return</span> <span class="n">decorated</span>
<span class="ln"> 9 </span>    <span class="k">return</span> <span class="n">actual_decorator</span>
<span class="ln">10 </span>
<span class="ln">11 </span><span class="nd">@login_required</span><span class="p">(</span><span class="s">'/login/'</span><span class="p">)</span>
<span class="ln">12 </span><span class="k">def</span> <span class="nf">edit_profile</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="ln">13 </span>    <span class="k">pass</span> <span class="c"># ...</span></pre><div class="notes"><p>A decorator that takes arguments is really a decorator factory: a function
that returns a decorator.</p><p>And a decorator, of course, is a function that returns a function: so we end
up with double-nested closures.</p></div></div><div class="step" step="15" data-emphasize-lines-step="9,10" data-x="24000" data-y="0"><h1 id="optionally-configurable">Optionally configurable</h1><pre class="highlight code python"><span class="ln"> 1 </span><span class="k">def</span> <span class="nf">login_required</span><span class="p">(</span><span class="n">view_func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">login_url</span><span class="o">=</span><span class="s">'/login/'</span><span class="p">):</span>
<span class="ln"> 2 </span>    <span class="k">def</span> <span class="nf">actual_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="ln"> 3 </span>        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="ln"> 4 </span>        <span class="k">def</span> <span class="nf">decorated</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="ln"> 5 </span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
<span class="ln"> 6 </span>                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">login_url</span><span class="p">)</span>
<span class="ln"> 7 </span>            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="ln"> 8 </span>        <span class="k">return</span> <span class="n">decorated</span>
<span class="ln"> 9 </span>    <span class="k">if</span> <span class="n">view_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
<span class="ln">10 </span>        <span class="k">return</span> <span class="n">actual_decorator</span><span class="p">(</span><span class="n">view_func</span><span class="p">)</span>
<span class="ln">11 </span>    <span class="k">return</span> <span class="n">actual_decorator</span>
<span class="ln">12 </span>
<span class="ln">13 </span><span class="nd">@login_required</span>
<span class="ln">14 </span><span class="k">def</span> <span class="nf">view_profile</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="ln">15 </span>    <span class="k">pass</span> <span class="c"># ...</span>
<span class="ln">16 </span>
<span class="ln">17 </span><span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">'/other_login/'</span><span class="p">)</span>
<span class="ln">18 </span><span class="k">def</span> <span class="nf">edit_profile</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="ln">19 </span>    <span class="k">pass</span> <span class="c"># ...</span></pre><div class="notes"><p>Combining the last two forms of decorators, returning either a decorator, or
an already-decorated view function, depending what arguments we get.</p><p>Could avoid the implementation complexity if we didn't mind a pair of empty
parens in the first usage, but requiring those makes it easier to use the
decorator wrong.</p><p>This requires passing in login_url as a keyword argument, we could be even
cleverer if we want by type-checking the first argument (is it a function?
is it a string?)</p></div></div><div class="step" step="16" data-emphasize-lines-step="4,6,7,8,9" data-x="25600" data-y="0"><h1 id="with-lazy-return-values">With lazy return values:</h1><pre class="highlight code python"><span class="ln"> 1 </span><span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="ln"> 2 </span>    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="ln"> 3 </span>    <span class="k">def</span> <span class="nf">decorated</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="ln"> 4 </span>        <span class="n">sort_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'sort'</span><span class="p">)</span>
<span class="ln"> 5 </span>        <span class="n">response</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="ln"> 6 </span>        <span class="k">if</span> <span class="n">sort_by</span><span class="p">:</span>
<span class="ln"> 7 </span>            <span class="n">ctx</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">'context'</span><span class="p">]</span>
<span class="ln"> 8 </span>            <span class="n">ctx</span><span class="p">[</span><span class="s">'queryset'</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">[</span><span class="s">'queryset'</span><span class="p">]</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
<span class="ln"> 9 </span>                <span class="n">sort_by</span><span class="p">)</span>
<span class="ln">10 </span>        <span class="k">return</span> <span class="n">response</span>
<span class="ln">11 </span>    <span class="k">return</span> <span class="n">decorated</span>
<span class="ln">12 </span>
<span class="ln">13 </span><span class="nd">@sort</span>
<span class="ln">14 </span><span class="k">def</span> <span class="nf">list_widgets</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="ln">15 </span>    <span class="k">return</span> <span class="n">TemplateResponse</span><span class="p">(</span>
<span class="ln">16 </span>        <span class="n">request</span><span class="p">,</span>
<span class="ln">17 </span>        <span class="s">'widget_list.html'</span><span class="p">,</span>
<span class="ln">18 </span>        <span class="p">{</span><span class="s">'queryset'</span><span class="p">:</span> <span class="n">Widget</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()},</span>
<span class="ln">19 </span>        <span class="p">)</span></pre><div class="notes"><p>TemplateResponse renders an HTML template lazily.</p><p>Our decorator can poke at the context before the template is rendered, to
sort the queryset.</p><p>This decorator can provide generic sortability to any view that renders a
queryset in its template.</p><p>(Needs error handling.)</p></div></div><div class="step" step="17" data-reveal="1" data-x="27200" data-y="0"><h1 id="caution">Caution</h1><ul><li>Decorator becomes part of the function.</li><li>Can't test the plain pre-decorated function.</li><li>Only use if:</li><li>Decorated version is equally testable</li><li>and the only version you need.</li></ul></div><div class="step" step="18" data-reveal="1" data-x="28800" data-y="0"><h1 id="context-managers">Context managers</h1><pre class="highlight code python"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'somefile.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'contents</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span></pre><ul><li>Like decorators, allow before/after actions.</li><li>But around any block of code, not just functions.</li></ul></div><div class="step" step="19" data-x="30400" data-y="0"><h1 id="can-replace-try-finally">Can replace try/finally</h1><p>In place of:</p><pre class="highlight code python"><span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'somefile.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'contents</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre><p>we can write:</p><pre class="highlight code python"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'somefile.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'contents</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span></pre><p>And the context manager closes the file for us at the end of the block.</p><div class="notes"><p>More concise syntax for resource management / cleanup.</p></div></div><div class="step" step="20" data-emphasize-lines-step="2,6,7,8,10,11,13" data-x="32000" data-y="0"><h1 id="writing-a-context-manager">Writing a context manager</h1><pre class="highlight code python"><span class="ln"> 1 </span><span class="k">class</span> <span class="nc">MyOpen</span><span class="p">:</span>
<span class="ln"> 2 </span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'r'</span><span class="p">):</span>
<span class="ln"> 3 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
<span class="ln"> 4 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
<span class="ln"> 5 </span>
<span class="ln"> 6 </span>    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="ln"> 7 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
<span class="ln"> 8 </span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fh</span>
<span class="ln"> 9 </span>
<span class="ln">10 </span>    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
<span class="ln">11 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="ln">12 </span>
<span class="ln">13 </span><span class="k">with</span> <span class="n">MyOpen</span><span class="p">(</span><span class="s">'somefile.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
<span class="ln">14 </span>    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'contents</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span></pre><div class="notes"><p><tt>open</tt> already can act like a context manager. But if not, here's a
simplified example of how we could implement it.</p><p>Just any object with <tt>__enter__</tt> and <tt>__exit__</tt> methods.</p><p>Return value of <tt>__enter__</tt> accessible via <tt>as</tt> keyword.</p></div></div><div class="step" step="21" data-emphasize-lines-step="7,9,13,17" data-kill-linenos="1" data-x="33600" data-y="0"><h1 id="exception-handling">Exception handling</h1><pre class="highlight code pycon"><span class="ln"> 1 </span><span class="k"></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">NoisyCM</span><span class="p">:</span>
<span class="ln"> 2 </span><span class="gp">... </span>    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="ln"> 3 </span><span class="gp">... </span>        <span class="k">print</span><span class="p">(</span><span class="s">"Entering!"</span><span class="p">)</span>
<span class="ln"> 4 </span><span class="gp">...</span>
<span class="ln"> 5 </span><span class="gp">... </span>    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
<span class="ln"> 6 </span><span class="gp">... </span>        <span class="k">print</span><span class="p">(</span><span class="s">"Exiting!"</span><span class="p">)</span>
<span class="ln"> 7 </span><span class="gp">... </span>        <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
<span class="ln"> 8 </span><span class="gp">... </span>            <span class="k">print</span><span class="p">(</span><span class="s">"Caught {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc_type</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
<span class="ln"> 9 </span><span class="gp">... </span>            <span class="k">return</span> <span class="bp">True</span>
<span class="ln">10 </span><span class="go">
</span><span class="ln">11 </span><span class="go"></span><span class="k"></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">NoisyCM</span><span class="p">():</span>
<span class="ln">12 </span><span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="s">"Inside!"</span><span class="p">)</span>
<span class="ln">13 </span><span class="gp">... </span>    <span class="k">raise</span> <span class="ne">ValueError</span>
<span class="ln">14 </span><span class="go">Entering!
</span><span class="ln">15 </span><span class="go">Inside!
</span><span class="ln">16 </span><span class="go">Exiting!
</span><span class="ln">17 </span><span class="go">Caught ValueError</span></pre><div class="notes"><p><tt>__exit__</tt> gives us info on any exception raised inside the with block</p><p>Can return <tt>True</tt> to suppress it, else it will propagate.</p></div></div><div class="step" step="22" data-emphasize-lines-step="1,3,7,8" data-x="35200" data-y="0"><h1 id="convenience-method">Convenience method</h1><pre class="highlight code python"><span class="ln"> 1 </span><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="ln"> 2 </span>
<span class="ln"> 3 </span><span class="nd">@contextmanager</span>
<span class="ln"> 4 </span><span class="k">def</span> <span class="nf">my_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'r'</span><span class="p">):</span>
<span class="ln"> 5 </span>    <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
<span class="ln"> 6 </span>    <span class="k">try</span><span class="p">:</span>
<span class="ln"> 7 </span>        <span class="k">yield</span> <span class="n">fh</span>
<span class="ln"> 8 </span>    <span class="k">finally</span><span class="p">:</span>
<span class="ln"> 9 </span>        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre><div class="notes"><p>When even a class with two methods is too much boilerplate,
<tt>contextmanager</tt> streamlines it.</p><p>Uses a decorator! Also a generator (yield statement); we'll see that soon.</p><p>Yielded value goes to 'as' clause; after the block, resumes after the yield.</p><p>If we want unconditional cleanup we still need to use a try/finally.</p></div></div><div class="step" step="23" data-reveal="1" data-x="36800" data-y="0"><h1 id="cautions">Cautions</h1><ul><li>None!</li><li>Context managers are awesome.</li><li>Use them anywhere you need to manage resource life-cycles; setup/teardown.</li></ul></div><div class="step" step="24" data-x="38400" data-y="0"><h1 id="descriptors">Descriptors</h1></div><div class="step" step="25" data-emphasize-lines-step="7,10,15" data-kill-linenos="1" data-x="40000" data-y="0"><p>Attributes are simple:</p><pre class="highlight code pycon"><span class="ln"> 1 </span><span class="k"></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
<span class="ln"> 2 </span><span class="gp">... </span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="ln"> 3 </span><span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<span class="ln"> 4 </span><span class="go">
</span><span class="ln"> 5 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Arthur Belling"</span><span class="p">)</span>
<span class="ln"> 6 </span><span class="go">
</span><span class="ln"> 7 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">name</span>
<span class="ln"> 8 </span><span class="go">'Arthur Belling'
</span><span class="ln"> 9 </span><span class="go">
</span><span class="ln">10 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Arthur Nudge"</span>
<span class="ln">11 </span><span class="go">
</span><span class="ln">12 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">name</span>
<span class="ln">13 </span><span class="go">'Arthur Nudge'
</span><span class="ln">14 </span><span class="go">
</span><span class="ln">15 </span><span class="go"></span><span class="k"></span><span class="gp">&gt;&gt;&gt; </span><span class="k">del</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span>
<span class="ln">16 </span><span class="go">
</span><span class="ln">17 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">name</span>
<span class="ln">18 </span><span class="gt">Traceback (most recent call last):
</span><span class="ln">19 </span><span class="gt"></span><span class="c">...</span>
<span class="ln">20 </span><span class="gr">AttributeError</span>: <span class="n">'Person' object has no attribute 'name'</span></pre><div class="notes"><p>We can get them, set them, and delete them.</p></div></div><div class="step" step="26" data-reveal="1" data-x="41600" data-y="0"><h1 id="python-is-not-java">Python is not Java</h1><ul><li>Attributes in Python are public.</li><li>We use attributes directly, not getters and setters.</li><li>But what if the implementation needs to change?</li><li>Descriptors!</li><li>Simple attribute from the outside.</li><li>Anything you want on the inside.</li></ul></div><div class="step" step="27" data-emphasize-lines-step="3,7,11" data-x="43200" data-y="0"><pre class="highlight code python"><span class="ln"> 1 </span><span class="k">class</span> <span class="nc">NoisyDescriptor</span><span class="p">:</span>
<span class="ln"> 2 </span>    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objtype</span><span class="p">):</span>
<span class="ln"> 3 </span>         <span class="k">print</span><span class="p">(</span><span class="s">"Getting"</span><span class="p">)</span>
<span class="ln"> 4 </span>         <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">_val</span>
<span class="ln"> 5 </span>
<span class="ln"> 6 </span>    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="ln"> 7 </span>         <span class="k">print</span><span class="p">(</span><span class="s">"Setting to {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
<span class="ln"> 8 </span>         <span class="n">obj</span><span class="o">.</span><span class="n">_val</span> <span class="o">=</span> <span class="n">val</span>
<span class="ln"> 9 </span>
<span class="ln">10 </span>    <span class="k">def</span> <span class="nf">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="ln">11 </span>         <span class="k">print</span><span class="p">(</span><span class="s">"Deleting"</span><span class="p">)</span>
<span class="ln">12 </span>         <span class="k">del</span> <span class="n">obj</span><span class="o">.</span><span class="n">_val</span></pre><div class="notes"><p>Still need to store underlying data somewhere. Here we use "_val" (private,
not enforced)</p><p>Only one instance of this decorator can be used per-class w/out sharing data.</p><p>Could pass in a name, generate one, use a metaclass...</p></div></div><div class="step" step="28" data-emphasize-lines-step="2,7,10,14" data-x="44800" data-y="0"><pre class="highlight code pycon"><span class="ln"> 1 </span><span class="k"></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
<span class="ln"> 2 </span><span class="gp">... </span>    <span class="n">name</span> <span class="o">=</span> <span class="n">NoisyDescriptor</span><span class="p">()</span>
<span class="ln"> 3 </span><span class="go">
</span><span class="ln"> 4 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">luigi</span> <span class="o">=</span> <span class="n">Person</span><span class="p">()</span>
<span class="ln"> 5 </span><span class="go">
</span><span class="ln"> 6 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">luigi</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Luigi"</span>
<span class="ln"> 7 </span><span class="go">Setting to Luigi
</span><span class="ln"> 8 </span><span class="go">
</span><span class="ln"> 9 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">luigi</span><span class="o">.</span><span class="n">name</span>
<span class="ln">10 </span><span class="go">Getting
</span><span class="ln">11 </span><span class="go">'Luigi'
</span><span class="ln">12 </span><span class="go">
</span><span class="ln">13 </span><span class="go"></span><span class="k"></span><span class="gp">&gt;&gt;&gt; </span><span class="k">del</span> <span class="n">luigi</span><span class="o">.</span><span class="n">name</span>
<span class="ln">14 </span><span class="go">Deleting</span></pre><div class="notes"><p>We set the descriptor as a class attribute.</p><p>Then when we get, or set, or delete the <tt>name</tt> attribute of an instance of
that class, it goes through the descriptor's methods.</p></div></div><div class="step" step="29" data-x="46400" data-y="0"><h1 id="head-asplode">Head Asplode</h1><ul><li>Descriptors are extremely powerful.</li><li>Usually, you don't need all that.</li><li>The built-in <tt>@property</tt> decorator is a simpler way to build a descriptor
for the common cases.</li></ul></div><div class="step" step="30" data-emphasize-lines-step="6,12,17" data-x="48000" data-y="0"><h1 id="calculated-property">calculated property</h1><pre class="highlight code python"><span class="ln"> 1 </span><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
<span class="ln"> 2 </span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">):</span>
<span class="ln"> 3 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="n">first_name</span>
<span class="ln"> 4 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="n">last_name</span>
<span class="ln"> 5 </span>
<span class="ln"> 6 </span>    <span class="nd">@property</span>
<span class="ln"> 7 </span>    <span class="k">def</span> <span class="nf">full_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="ln"> 8 </span>        <span class="k">return</span> <span class="s">"{} {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="ln"> 9 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span></pre><pre class="highlight code pycon"><span class="ln">1 </span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="s">"Eric"</span><span class="p">,</span> <span class="s">"Praline"</span><span class="p">)</span>
<span class="ln">2 </span><span class="go">
</span><span class="ln">3 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">full_name</span>
<span class="ln">4 </span><span class="go">'Eric Praline'
</span><span class="ln">5 </span><span class="go">
</span><span class="ln">6 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">full_name</span> <span class="o">=</span> <span class="s">"John Cleese"</span>
<span class="ln">7 </span><span class="gt">Traceback (most recent call last):
</span><span class="ln">8 </span><span class="gt"></span><span class="gr">AttributeError</span>: <span class="n">can't set attribute</span></pre><div class="notes"><p>Use the built-in 'property' decorator to turn a method into a descriptor
with __get__.</p><p>Note we access it as an attribute; from the outside there is no clue that it
isn't an ordinary attribute.</p><p>Until we try to set it, that is - it's read-only.</p></div></div><div class="step" step="31" data-emphasize-lines-step="4,6,7,9,18" data-x="49600" data-y="0"><h1 id="boolean-only-attribute">boolean-only attribute</h1><pre class="highlight code python"><span class="ln"> 1 </span><span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
<span class="ln"> 2 </span>    <span class="nd">@property</span>
<span class="ln"> 3 </span>    <span class="k">def</span> <span class="nf">is_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="ln"> 4 </span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span>
<span class="ln"> 5 </span>
<span class="ln"> 6 </span>    <span class="nd">@is_admin.setter</span>
<span class="ln"> 7 </span>    <span class="k">def</span> <span class="nf">is_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="ln"> 8 </span>        <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">}:</span>
<span class="ln"> 9 </span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="ln">10 </span>                <span class="s">'is_admin must be True or False'</span><span class="p">)</span>
<span class="ln">11 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span> <span class="o">=</span> <span class="n">val</span></pre><pre class="highlight code pycon"><span class="ln">1 </span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
<span class="ln">2 </span><span class="go">
</span><span class="ln">3 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">u</span><span class="o">.</span><span class="n">is_admin</span> <span class="o">=</span> <span class="bp">True</span>
<span class="ln">4 </span><span class="go">
</span><span class="ln">5 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">u</span><span class="o">.</span><span class="n">is_admin</span> <span class="o">=</span> <span class="s">'foo'</span>
<span class="ln">6 </span><span class="gt">Traceback (most recent call last):
</span><span class="ln">7 </span><span class="gt"></span><span class="gr">ValueError</span>: <span class="n">is_admin must be True or False</span></pre><div class="notes"><p>Define the getter same as before; internally we are using "_is_admin" to
store the value.</p><p>Then it gets interesting:</p><ul><li><tt>property</tt> turns <tt>is_admin</tt> into a descriptor.</li><li>The descriptor has a <tt>setter</tt> method, which is a decorator.</li><li>We use that decorator to define a setter for this property.</li></ul><p>In our setter we check to ensure the value is boolean, and if so, set it.</p><p>If not, raise a ValueError.</p><p>(<tt>deleter</tt> and <tt>getter</tt> also available.)</p></div></div><div class="step" step="32" data-emphasize-lines-step="2,5,11" data-x="51200" data-y="0"><h1 id="alternate-spelling">alternate spelling</h1><pre class="highlight code python"><span class="ln"> 1 </span><span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
<span class="ln"> 2 </span>    <span class="k">def</span> <span class="nf">_get_is_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="ln"> 3 </span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span>
<span class="ln"> 4 </span>
<span class="ln"> 5 </span>    <span class="k">def</span> <span class="nf">_set_is_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="ln"> 6 </span>        <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">}:</span>
<span class="ln"> 7 </span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="ln"> 8 </span>                <span class="s">'is_admin must be True or False'</span><span class="p">)</span>
<span class="ln"> 9 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">_is_admin</span> <span class="o">=</span> <span class="n">val</span>
<span class="ln">10 </span>
<span class="ln">11 </span>    <span class="n">is_admin</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_is_admin</span><span class="p">,</span> <span class="n">_set_is_admin</span><span class="p">)</span></pre><div class="notes"><p>If you find the decorators for getter/setter properties hard to grok, you
might find this alternate spelling clearer.</p><p>Just define the getter and setter with private names and pass in to the
property constructor.</p><p>Same effect as before.</p><p>Can pass in a deleter method as third arg.</p></div></div><div class="step" step="33" data-reveal="1" data-x="52800" data-y="0"><h1 id="descriptors-properties">Descriptors &amp; properties</h1><ul><li>Hide getters &amp; setters behind simple-attribute facade.</li><li>Descriptor protocol is fundamental to Python's object model: used internally
to implement bound methods, staticmethods, classmethods...</li><li>For most cases <tt>property</tt> is simpler than a custom descriptor class.</li><li>In Python 2, can only be used with "new-style" classes (inherit <tt>object</tt>).</li></ul></div><div class="step" step="34" data-x="54400" data-y="0"><h1 id="iterables-iterators-generators-oh-my">Iterables, iterators, &amp; generators, oh my!</h1></div><div class="step" step="35" data-x="56000" data-y="0"><h1 id="iteration-is-simple">Iteration is simple.</h1><pre class="highlight code pycon"><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="go">
</span><span class="k"></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="go">1
2
3</span></pre><div class="notes"><p>We can make a list, and then use <tt>for ... in ...</tt> to iterate over that
list.</p></div></div><div class="step" step="36" data-reveal="1" data-x="57600" data-y="0"><h1 id="what-is-iterable">What is <strong>iterable</strong>?</h1><ul><li>List, set, tuple, dict...</li><li>Any object with an <tt>__iter__</tt> method.</li><li>The <tt>__iter__</tt> method must return an <strong>iterator</strong>.</li></ul><div class="notes"><p>The term for objects that we can iterate over is "iterable".</p><p>Many built-in types are iterable: list, set, tuple, dict...</p><p>Any object can be iterable; it just needs an <tt>__iter__</tt> method.</p><p>Which must return an iterator.</p><p>Which of course raises the question...</p></div></div><div class="step" step="37" data-reveal="1" data-x="59200" data-y="0"><h1 id="ok-what-s-an-iterator">Ok, what's an <strong>iterator</strong>?</h1><ul><li>An <strong>iterator</strong> keeps track of where we are in iterating over some
collection.</li><li>Has a <tt>__next__()</tt> method that gives us the next item when we ask for it.</li><li>Raises a <tt>StopIteration</tt> exception when there are no more items.</li><li>Used internally every time you use <tt>for ... in</tt>, but usually hidden.</li><li>But we can see one, now that we know where to look...</li></ul></div><div class="step" step="38" data-reveal="1" data-x="60800" data-y="0"><h1 id="an-aside-magic-methods">An aside: magic methods</h1><ul><li>Python's data model is largely implemented via "magic-method protocols."</li><li>E.g. any object can implement a <tt>__len__()</tt> method; <tt>len(obj)</tt> is
equivalent to <tt>obj.__len__()</tt>.</li><li>Allows user classes to participate fully in the language syntax; not be
second-class to built-in types.</li><li>Many others: comparison (e.g. <tt>__eq__()</tt>), type conversion
(e.g. <tt>__str__()</tt>), attribute access (e.g. <tt>__getattr__()</tt>), descriptors
(<tt>__get__()</tt> et al). Look up the full list!</li><li>the iterable (<tt>__iter__()</tt>) and iterator (<tt>__next__()</tt>) protocols.</li><li>As with <tt>len()</tt>, there are <tt>iter()</tt> and <tt>next()</tt> built-ins;
<tt>iter(obj)</tt> just calls <tt>obj.__iter__()</tt>.</li></ul></div><div class="step" step="39" data-emphasize-lines-step="6,9,12,15,19" data-kill-linenos="1" data-x="62400" data-y="0"><h1 id="look-an-iterator">look, an iterator!</h1><pre class="highlight code pycon"><span class="ln"> 1 </span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="ln"> 2 </span><span class="go">
</span><span class="ln"> 3 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
<span class="ln"> 4 </span><span class="go">
</span><span class="ln"> 5 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">iterator</span>
<span class="ln"> 6 </span><span class="go">&lt;list_iterator object at 0x...&gt;
</span><span class="ln"> 7 </span><span class="go">
</span><span class="ln"> 8 </span><span class="go"></span><span class="nb"></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
<span class="ln"> 9 </span><span class="go">1
</span><span class="ln">10 </span><span class="go">
</span><span class="ln">11 </span><span class="go"></span><span class="nb"></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
<span class="ln">12 </span><span class="go">2
</span><span class="ln">13 </span><span class="go">
</span><span class="ln">14 </span><span class="go"></span><span class="nb"></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
<span class="ln">15 </span><span class="go">3
</span><span class="ln">16 </span><span class="go">
</span><span class="ln">17 </span><span class="go"></span><span class="nb"></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
<span class="ln">18 </span><span class="gt">Traceback (most recent call last):
</span><span class="ln">19 </span><span class="gt"></span><span class="gr">StopIteration</span></pre><div class="notes"><p>We can get an iterator for a list, and then keep calling <tt>next()</tt> on it
and getting the next item in the list, until finally it raises
<tt>StopIteration</tt>.</p><p>Wondering why you don't see <tt>StopIteration</tt> all over the place? The
<tt>for</tt> loop (and other kinds of built-in iteration, such as comprehensions)
catch it for you; that's how they know when iteration is done.</p></div></div><div class="step" step="40" data-emphasize-lines-step="1,4,6" data-x="64000" data-y="0"><h1 id="the-true-story-of-a-for-loop">The true story of a for loop</h1><p>So what really happens when I <tt>for x in numbers: print(x)</tt>?</p><pre class="highlight code python"><span class="ln">1 </span><span class="n">iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
<span class="ln">2 </span><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
<span class="ln">3 </span>    <span class="k">try</span><span class="p">:</span>
<span class="ln">4 </span>        <span class="n">x</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
<span class="ln">5 </span>    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
<span class="ln">6 </span>        <span class="k">break</span>
<span class="ln">7 </span>    <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></pre><div class="notes"><p>Get an iterator, keep calling <tt>next()</tt> on that iterator until it raises
<tt>StopIteration</tt>.</p></div></div><div class="step" step="41" data-emphasize-lines-step="8,11" data-kill-linenos="1" data-x="65600" data-y="0"><h1 id="two-iterators-one-list">two iterators, one list</h1><pre class="highlight code pycon"><span class="ln"> 1 </span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="ln"> 2 </span><span class="go">
</span><span class="ln"> 3 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">iter1</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
<span class="ln"> 4 </span><span class="go">
</span><span class="ln"> 5 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">iter2</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
<span class="ln"> 6 </span><span class="go">
</span><span class="ln"> 7 </span><span class="go"></span><span class="nb"></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">iter1</span><span class="p">)</span>
<span class="ln"> 8 </span><span class="go">1
</span><span class="ln"> 9 </span><span class="go">
</span><span class="ln">10 </span><span class="go"></span><span class="nb"></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">iter2</span><span class="p">)</span>
<span class="ln">11 </span><span class="go">1
</span><span class="ln">12 </span><span class="go">
</span><span class="ln">13 </span><span class="go"></span><span class="k"></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">:</span>
<span class="ln">14 </span><span class="gp">... </span>    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">:</span>
<span class="ln">15 </span><span class="gp">... </span>        <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="ln">16 </span><span class="go">1 1
</span><span class="ln">17 </span><span class="go">1 2
</span><span class="ln">18 </span><span class="go">2 1
</span><span class="ln">19 </span><span class="go">2 2</span></pre><div class="notes"><p>We can get two different iterators for the same underlying list, and they
each maintain their own separate iteration state.</p><p>This is why you can do nested for loops over the same list, and they don't
interfere with each other.</p></div></div><div class="step" step="42" data-emphasize-lines-step="5,11" data-kill-linenos="1" data-x="67200" data-y="0"><h1 id="iterators-are-iterable">iterators are iterable</h1><p>Iterators should define an <tt>__iter__()</tt> method that returns <tt>self</tt>.</p><p>This means an iterator is also iterable (but one-shot).</p><pre class="highlight code pycon"><span class="ln"> 1 </span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="ln"> 2 </span><span class="go">
</span><span class="ln"> 3 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
<span class="ln"> 4 </span><span class="go">
</span><span class="ln"> 5 </span><span class="go"></span><span class="k"></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
<span class="ln"> 6 </span><span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="ln"> 7 </span><span class="go">1
</span><span class="ln"> 8 </span><span class="go">2
</span><span class="ln"> 9 </span><span class="go">3
</span><span class="ln">10 </span><span class="go">
</span><span class="ln">11 </span><span class="go"></span><span class="k"></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
<span class="ln">12 </span><span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="n">num</span><span class="p">)</span></pre><div class="notes"><p>Also, because iterators are one-shot, you can't do nested loops over the
same iterator like you can with a list (whose <tt>__iter__()</tt> returns a new
iterator each time).</p></div></div><div class="step" step="43" data-emphasize-lines-step="6,11" data-kill-linenos="1" data-x="68800" data-y="0"><h1 id="fibonacci-iterator">fibonacci iterator</h1><pre class="highlight code python"><span class="ln"> 1 </span><span class="k">class</span> <span class="nc">Fibonacci</span><span class="p">:</span>
<span class="ln"> 2 </span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="ln"> 3 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">last</span> <span class="o">=</span> <span class="mi">0</span>
<span class="ln"> 4 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">next</span> <span class="o">=</span> <span class="mi">1</span>
<span class="ln"> 5 </span>
<span class="ln"> 6 </span>    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="ln"> 7 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">last</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">next</span> <span class="o">=</span> <span class="p">(</span>
<span class="ln"> 8 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">next</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">next</span><span class="p">)</span>
<span class="ln"> 9 </span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">last</span>
<span class="ln">10 </span>
<span class="ln">11 </span>    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="ln">12 </span>        <span class="k">return</span> <span class="bp">self</span></pre><pre class="highlight code pycon"><span class="ln">1 </span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">Fibonacci</span><span class="p">()</span>
<span class="ln">2 </span><span class="go">
</span><span class="ln">3 </span><span class="go"></span><span class="k"></span><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
<span class="ln">4 </span><span class="go">1 1 2 3 5</span></pre><div class="notes"><p>Fibonacci is always used as an example of recursion -- we're going to use it
as a demonstration of iteration instead.</p><p>We define a <tt>__next__()</tt> method (makes it an iterator) and an
<tt>__iter__()</tt> method that returns itself (so its iterable; we can use it in
a for loop.</p><p>But I don't use it in a for loop. Why? Note we never raise <tt>StopIteration</tt>
from <tt>next()</tt>; this is an infinite iterator!</p></div></div><div class="step" step="44" data-emphasize-lines-step="3,5" data-kill-linenos="1" data-x="70400" data-y="0"><h1 id="itertools-iterator-plumbing">itertools: iterator plumbing</h1><pre class="highlight code pycon"><span class="ln">1 </span><span class="kn"></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">takewhile</span>
<span class="ln">2 </span><span class="go">
</span><span class="ln">3 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">fib</span> <span class="o">=</span> <span class="n">takewhile</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">Fibonacci</span><span class="p">())</span>
<span class="ln">4 </span><span class="go">
</span><span class="ln">5 </span><span class="go"></span><span class="n"></span><span class="gp">&gt;&gt;&gt; </span><span class="n">multiple_of_7</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">7</span><span class="p">,</span> <span class="n">fib</span><span class="p">)</span>
<span class="ln">6 </span><span class="go">
</span><span class="ln">7 </span><span class="go"></span><span class="nb"></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">multiple_of_7</span><span class="p">)</span>
<span class="ln">8 </span><span class="go">[21, 987, 46368]</span></pre><div class="notes"><p>The <tt>itertools</tt> module contains a bunch of "pipes" you can connect
together to do interesting things with iterators.</p><p>Just one quick example - check out the docs for lots more!</p><p>We use <tt>takewhile</tt> to limit the infinite Fibonacci iterator to just
elements under 100,000.</p><p>Then we use <tt>filter</tt> to filter it down to just those that are divisible by
7.</p><p>This processes only one element at a time, so we won't exhaust memory no
matter how high we go.</p></div></div><div class="step" step="45" id="questions" data-x="72000" data-y="0"><h1 id="questions">Questions?</h1><ul><li><a href="http://oddbird.net/advanced-python-preso">oddbird.net/advanced-python-preso</a></li><li><a href="http://docs.python.org/3/reference/datamodel.html">docs.python.org/3/reference/datamodel.html</a></li><li><a href="http://docs.python.org/3/glossary.html">docs.python.org/3/glossary.html</a></li><li><a href="http://docs.python.org/3/howto/descriptor.html">docs.python.org/3/howto/descriptor.html</a></li><li><a href="http://docs.python.org/3/tutorial/classes.html">docs.python.org/3/tutorial/classes.html</a></li><li><a href="http://docs.python.org/3/library/itertools.html">docs.python.org/3/library/itertools.html</a></li></ul><p><div class="vcard">
<a href="http://www.oddbird.net">
  <img src="images/logo.svg" alt="OddBird" class="logo" />
</a>
<h2 class="fn">Carl Meyer</h2>
<ul class="links">
  <li><a href="http://www.oddbird.net" class="org url">oddbird.net</a></li>
  <li><a href="https://twitter.com/carljm" rel="me">@carljm</a></li>
</ul>
</div></p></div></div><div id="hovercraft-help" class="hide"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Left, Down, Page Down</th><td>Next slide</td></tr><tr><th>Right, Up, Page Up</th><td>Previous slide</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/jquery-2.1.0.min.js"></script><script type="text/javascript" src="js/oddbird.js"></script><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script></body></html>